#!/usr/bin/env sh

set -e
set -u

#trap 'p=$? ; command rm -f .lock ; exit $p' 1 2 3 6 9 15 EXIT
if
         exec 9<"$0";
         ! command flock -n 9
then
         printf '%s\n' "latch/error: Sorry, I am already running" 1>&2;
         exit 1
fi

_a= \
myAction= \
myArgs= \
myCheckout= \
myKey= \
myKeyRing= \
myLog= \
myMirror= \
myMirrorList= \
myMrAction= \
myPkgList= \
myRoot=;

myRoot="$(
        rl="$(command readlink -fn -- "$0")";
        command dirname -- "$rl"
)"
myRoot="${myRoot%/bin}"

readonly \
        myCheckout="${myRoot}/var/checkout" \
        myKey="${myRoot}/var/key" \
        myKeyRing="${myRoot}/var/ring" \
        myLog="${myRoot}/var/log" \
        myMirror="${myRoot}/var/mirror" \
        myMirrorList="${myRoot}/var/mirror.list" \
        myPkgList="${myRoot}/var/pkg.list" \
        myRoot;

export \
        myCheckout \
        myKey \
        myKeyRing \
        myLog \
        myMirror \
        myMirrorList \
        myPkgList \
        myRoot;

. "${myRoot}/lib/setup.sh"

msg "latch/main: myRoot -> ${myRoot}"
msg "latch/main: myKeyRing -> ${myKeyRing}"
msg "latch/main: myKey -> ${myKey}"
msg "latch/main: myMirror -> ${myMirror}"
msg "latch/main: myLog -> ${myLog}"
msg "latch/main: myCheckout -> ${myCheckout}"

for _a
do
        case "$_a" in
        forge|mr|pkg|rehash)
                readonly myAction="$_a"
                msg "latch/main: myAction -> ${myAction}"
                shift 1
        ;;
        *)
                myArgs="${myArgs:+${myArgs} }'${_a}'"
                shift 1
        esac
done

: "${myArgs:={\}}"
msg "latch/main: myArgs -> ${myArgs}"
readonly myArgs

command mkdir -p \
        "$myCheckout" \
        "$myKey" \
        "$myKeyRing" \
        "$myLog" \
        "$myMirror";

action "$myAction"

# vim: set ft=sh ts=8 sw=8 tw=0 et :
