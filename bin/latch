#!/usr/bin/env sh

set -e
set -u

if
         exec 9<"$0";
         ! command flock -n 9
then
         printf '%s\n' "latch/main/error: sorry, I am already running" 1>&2;
         exit 1
fi

command umask 002

_a= \
myAction= \
myArgs= \
myBuild= \
myCheckout= \
myKey= \
myKeyRing= \
myLog= \
myMirror= \
myMirrorList= \
myPkgList= \
myRoot=;

myRoot="$(
        rl="$(command readlink -fn -- "$0")";
        command dirname -- "$rl"
)"
myRoot="${myRoot%/bin}"

readonly \
        myBuild="${myRoot}/tmp/build" \
        myCheckout="${myRoot}/tmp/checkout" \
        myKey="${myRoot}/tmp/key" \
        myKeyRing="${myRoot}/var/ring" \
        myLog="${myRoot}/var/log" \
        myMirror="${myRoot}/var/mirror" \
        myMirrorList="${myRoot}/var/mirror.list" \
        myPkgList="${myRoot}/var/pkg.list" \
        myRoot;

export \
        myBuild \
        myCheckout \
        myKey \
        myKeyRing \
        myLog \
        myMirror \
        myMirrorList \
        myPkgList \
        myRoot;

. "${myRoot}/lib/setup.sh"

msg "myRoot := ${myRoot}"
msg "myBuild := ${myBuild}"
msg "myCheckout := ${myCheckout}"
msg "myKey := ${myKey}"
msg "myKeyRing := ${myKeyRing}"
msg "myLog := ${myLog}"
msg "myMirror := ${myMirror}"

for _a
do
        case "$_a" in
        forge|mr|pkg|rehash|stow)
                readonly myAction="$_a"
                msg "myAction := ${myAction}"
                shift 1
        ;;
        *)
                myArgs="${myArgs:+${myArgs} }'${_a}'"
                shift 1
        esac
done

: "${myArgs:={\}}"
msg "myArgs := ${myArgs}"
readonly myArgs

command mkdir -p \
        "$myBuild" \
        "$myCheckout" \
        "$myKey" \
        "$myKeyRing" \
        "$myLog" \
        "$myMirror";

action "$myAction"

# vim: set ft=sh ts=8 sw=8 tw=0 et :
